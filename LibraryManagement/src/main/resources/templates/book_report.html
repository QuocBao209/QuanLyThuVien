
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/book_report.css}">
    <title>Báo cáo số lượng sách</title>
    <!-- Tải Chart.js từ CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
	<!-- Sidebar -->
	<div th:replace="admin :: sidebar"></div>

	<!-- Nội dung chính -->
	<div class="content-container">
    	<h2>Báo cáo số lượng sách</h2>
    	<!-- Toolbar -->
		<div class="toolbar">
			<form th:action="@{/admin/statistics/book-report}" method="post" 
					onsubmit="return validateForm()" id="statsForm">
				<!-- Nhóm ô tìm kiếm -->
				<div class="input-group">
					<label>Tìm kiếm:</label>
					<input type="text" id="searchQuery" name="query" 
						placeholder="Nhập thông tin sách..." th:value="${param.query}">
					
					<!-- Nhóm ô Tháng - Năm -->
					<label>Tháng:</label>
					<input type="number" id="month" name="month" placeholder="Nhập tháng (1-12)" th:value="${param.month}">
					<label>Năm:</label>
					<input type="number" id="year" name="year" placeholder="Nhập năm (VD: 2023)" th:value="${param.year}">
					
					<!-- Nút tìm kiếm và làm mới -->
					<button type="submit">Tìm kiếm</button>
					<button type="button" class="reset-btn" onclick="resetForm()">Làm mới</button>
				</div>

				<!-- Thông báo lỗi -->
				<span id="errorMsg" class="error-msg"></span>
			</form>
		</div>

	    <!-- Tổng quan số liệu -->
	    <div class="stats-overview">
	        <div class="stat-box">
	            <h4>Số sách đã mượn</h4>
	            <p th:text="${totalBorrowed} ?: 'N/A'"></p>
	        </div>
	        <div class="stat-box">
	            <h4>Số sách tồn kho</h4>
	            <p th:text="${totalAvailable} ?: 'N/A'"></p>
	        </div>
	        <div class="stat-box">
	            <h4>Số sách bị hư/mất</h4>
	            <p th:text="${totalDamaged} ?: 'N/A'"></p>
	        </div>
	    </div>
	
	    <!-- Biểu đồ -->
	    <div class="chart-container" th:if="${#lists.isEmpty(labels)} == false">
	        <canvas id="bookChart"></canvas>
	    </div>
	    <div class="no-data" th:if="${#lists.isEmpty(labels)}">
	        Không có dữ liệu để hiển thị biểu đồ.
	    </div>
	</div>

<script th:inline="javascript">
    // Dữ liệu biểu đồ từ Controller (truyền qua Thymeleaf)
    const labels = /*[[${labels}]]*/ [];
    const data = /*[[${data}]]*/ [];

    // Vẽ biểu đồ cột với Chart.js (chỉ vẽ nếu có dữ liệu)
    if (labels.length > 0) {
        const ctx = document.getElementById('bookChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar', // Biểu đồ cột
            data: {
                labels: labels, // Nhãn (thể loại sách)
                datasets: [{
                    label: 'Số lượng sách mượn',
                    data: data, // Số lượng sách mượn theo thể loại
                    backgroundColor: '#1ABC9C',
                    borderColor: '#16a085',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Số lượng sách mượn',
                            color: '#ECF0F1'
                        },
                        ticks: {
                            color: '#ECF0F1'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Thể loại sách',
                            color: '#ECF0F1'
                        },
                        ticks: {
                            color: '#ECF0F1'
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: '#ECF0F1'
                        }
                    },
                    tooltip: {
                        backgroundColor: '#34495E',
                        titleColor: '#ECF0F1',
                        bodyColor: '#ECF0F1'
                    }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }
    
 	// Các method xử lý toolbar
    function validateForm() {
        const month = document.getElementById('month').value.trim();
        const year = document.getElementById('year').value.trim();
        const errorMsg = document.getElementById('errorMsg');

        if (month && !year) {
            errorMsg.textContent = "Vui lòng nhập năm khi đã nhập tháng!";
            errorMsg.style.display = "block";
            return false;
        }
        
        errorMsg.style.display = "none";
        return true;
    }

    function resetForm() {
        const form = document.getElementById('statsForm');
        form.reset();
        document.getElementById('searchQuery').value = '';
        document.getElementById('month').value = '';
        document.getElementById('year').value = '';
        form.submit();
    }

    window.onload = function () {
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('query');
        const month = urlParams.get('month');
        const year = urlParams.get('year');

        if (query) document.getElementById('searchQuery').value = query;
        if (month) document.getElementById('month').value = month;
        if (year) document.getElementById('year').value = year;
    };

</script>
</body>
</html>
<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Sách mượn theo tháng</title>
	<link rel="stylesheet" th:href="@{/css/monthly_borrow.css}">
	<link rel="stylesheet" th:href="@{/css/admin.css}">
</head>
<body>
	<!-- Sidebar -->
	<div th:replace="admin :: sidebar"></div>
	
	<div class="main-container">
		<h2>Sách mượn theo tháng</h2>
		<div class="toolbar">
			<form th:action="@{/admin/statistics/books-per-month/book-borrow-stats}" method="post" 
					onsubmit="updateHiddenFields()" id="statsForm">
				<!-- Ô tìm kiếm -->
				<label>Tìm kiếm:</label>
				<input type="text" id="searchQuery" name="query" 
					placeholder="Nhập thông tin sách..." th:value="${param.query}" onchange="submitForm()">
				<span id="errorMsg" class="error-msg" style="display: none;"></span>
				
				<!-- Chọn Tháng - Năm -->
                <label>Tháng - Năm:</label>
                <select id="month" name="month">
                    <option value="" th:selected="${param.month == null}">Chọn tháng</option>
                    <option th:each="m : ${#numbers.sequence(1, 12)}" 
                    		th:value="${m}" 
                    		th:text="${m}" 
                    		th:selected="${param.month != null and param.month == m}"></option>
                </select>
                <select id="year" name="year">
                    <option value="" th:selected="${param.year == null}">Chọn năm</option>
                    <option th:each="y : ${#numbers.sequence(2020, #dates.year(#dates.createNow()))}" 
                    th:value="${y}" 
                    th:text="${y}" 
                    th:selected="${param.year != null and param.year == y}"></option>
                </select>
                <input type="hidden" id="hiddenMonth" name="month" />
                <input type="hidden" id="hiddenYear" name="year" />

                <!-- Nút tìm kiếm và làm mới -->
                <button type="submit">Tìm kiếm</button>
                <button type="button" class="reset-btn" onclick="resetForm()">Làm mới</button>
                <button type="submit" class="statistics-btn">Thống kê</button>
            </form>
		</div>
		
		<table class="table">
			<thead>
				<tr>
					<th>ID</th>
                    <th>Ảnh</th>
                    <th>Tên sách</th>
                    <th>Tác giả</th>
                    <th>Thể loại</th>
                    <th>Số lượng</th>
                    <th>Số lượng mượn</th>
				</tr>
			</thead>
			<tbody>
                <tr th:each="book : ${books}">
                    <td th:text="${book.bookId}"></td>
					<td>
						<img th:src="@{/images/book_images/{img}(img=${book.bookImage})}" alt="Ảnh bìa" width="80">
					</td>
					<td th:text="${book.bookName}"></td>
					<td>
			            <span th:each="author, iterStat : ${book.authors}">
			                <span th:text="${author.authorName}"></span>
			                <span th:if="${!iterStat.last}">, </span>
			            </span>
					</td>
					<td th:text="${book.category.categoryName}"></td>
					<td th:text="${book.amount}"></td>
					<td th:text="${book.borrowCount}"></td> <!-- Hiển thị số lượng mượn -->
                </tr>
                
                <!-- Thông báo không có dữ liệu -->
                <tr th:if="${#lists.isEmpty(books)}">
				    <td colspan="9" class="no-data">Không có dữ liệu</td>
				</tr>
            </tbody>
		</table>
	</div>
</body>

<script>
//Cập nhật giá trị tháng/năm vào input ẩn trước khi submit
function updateHiddenFields() {
	document.getElementById('hiddenMonth').value = document.getElementById('month').value;
	document.getElementById('hiddenYear').value = document.getElementById('year').value;
}

// Giữ lại giá trị tháng/năm sau khi tải lại trang
window.onload = function () {
	const urlParams = new URLSearchParams(window.location.search);
	const selectedMonth = urlParams.get('month');
	const selectedYear = urlParams.get('year');

	if (selectedMonth) {
		document.getElementById('month').value = selectedMonth;
	}
	if (selectedYear) {
		document.getElementById('year').value = selectedYear;
	}
};

// Làm mới form (xóa bộ lọc nhưng không submit ngay)
function resetForm() {
    window.location.href = '/admin/statistics/books-per-month/book-borrow-stats';
}

</script>

</html>
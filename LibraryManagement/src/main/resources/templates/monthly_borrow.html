<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Sách mượn theo tháng</title>
	<link rel="stylesheet" th:href="@{/css/monthly_borrow.css}">
	<link rel="stylesheet" th:href="@{/css/admin.css}">
</head>
<body>
	<!-- Sidebar -->
	<div th:replace="admin :: sidebar"></div>
	
	<div class="main-container">
		<h2>Sách mượn theo tháng</h2>
		<!-- Toolbar -->
		<div class="toolbar">
			<form th:action="@{/admin/statistics/books-per-month/book-borrow-stats}" method="post" 
					onsubmit="return validateForm()" id="statsForm">
				<!-- Nhóm ô tìm kiếm -->
				<div class="input-group">
					<label>Tìm kiếm:</label>
					<input type="text" id="searchQuery" name="query" 
						placeholder="Nhập thông tin sách..." th:value="${param.query}">
					
					<!-- Nhóm ô Tháng - Năm -->
					<label>Tháng:</label>
					<input type="number" id="month" name="month" placeholder="Nhập tháng (1-12)" th:value="${param.month}">
					<label>Năm:</label>
					<input type="number" id="year" name="year" placeholder="Nhập năm (VD: 2023)" th:value="${param.year}">
					
					<!-- Nút tìm kiếm và làm mới -->
					<button type="submit">Tìm kiếm</button>
					<button type="button" class="reset-btn" onclick="resetForm()">Làm mới</button>
				</div>

				<!-- Thông báo lỗi -->
				<span id="errorMsg" class="error-msg"></span>
			</form>
		</div>
		
		<table class="table">
			<thead>
				<tr>
					<th>ID</th>
                    <th>Ảnh</th>
                    <th>Tên sách</th>
                    <th>Tác giả</th>
                    <th>Thể loại</th>
                    <th>Số lượng</th>
                    <th>Số lượng mượn</th>
				</tr>
			</thead>
			<tbody>
                <tr th:each="book : ${books}">
                    <td th:text="${book.bookId}"></td>
					<td>
						<img th:src="@{/images/book_images/{img}(img=${book.bookImage})}" alt="Ảnh bìa" width="80">
					</td>
					<td th:text="${book.bookName}"></td>
					<td>
			            <span th:each="author, iterStat : ${book.authors}">
			                <span th:text="${author.authorName}"></span>
			                <span th:if="${!iterStat.last}">, </span>
			            </span>
					</td>
					<td th:text="${book.category.categoryName}"></td>
					<td th:text="${book.amount}"></td>
					<td th:text="${book.borrowCount}"></td>
                </tr>
                
                <tr th:if="${#lists.isEmpty(books)}">
				    <td colspan="9" class="no-data">Không có dữ liệu</td>
				</tr>
            </tbody>
		</table>
	</div>
</body>

<script>
function validateForm() {
    const month = document.getElementById('month').value.trim();
    const year = document.getElementById('year').value.trim();
    const errorMsg = document.getElementById('errorMsg');

    if (month && !year) {
        errorMsg.textContent = "Vui lòng nhập năm khi đã nhập tháng!";
        errorMsg.style.display = "block";
        return false;
    }
    
    errorMsg.style.display = "none";
    return true;
}

function resetForm() {
    const form = document.getElementById('statsForm');
    form.reset();
    document.getElementById('searchQuery').value = '';
    document.getElementById('month').value = '';
    document.getElementById('year').value = '';
    form.submit();
}

window.onload = function () {
    const urlParams = new URLSearchParams(window.location.search);
    const query = urlParams.get('query');
    const month = urlParams.get('month');
    const year = urlParams.get('year');

    if (query) document.getElementById('searchQuery').value = query;
    if (month) document.getElementById('month').value = month;
    if (year) document.getElementById('year').value = year;
};
</script>

</html>
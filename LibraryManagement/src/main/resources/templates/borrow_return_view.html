<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω t√†i kho·∫£n</title>
    <link rel="stylesheet" th:href="@{/css/borrow_return_view.css}">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <script>
        function openReturnForm(borrowId) {
            document.getElementById("returnForm-" + borrowId).style.display = "flex";
        }

        function closeReturnForm(borrowId) {
            document.getElementById("returnForm-" + borrowId).style.display = "none";
        }
    </script>
</head>
<body>
    <!-- Sidebar -->
    <div th:replace="admin :: sidebar"></div>

    <!-- Form danh s√°ch -->
    <div class="container">
        <form th:action="@{/admin/search-book}" method="post" class="search-container">
            <input type="text" name="keyword" placeholder="Nh·∫≠p t√™n s√°ch ho·∫∑c t√™n t√°c gi·∫£ ...">
            <button type="submit" class="search-btn">üîç T√¨m ki·∫øm</button>
        </form>

        <h2 th:text="|Ng∆∞·ªùi d√πng : ${borrowReturns[0].user.name}|"></h2>
        
        <!-- Th√¥ng b√°o tr·∫£ th√†nh c√¥ng -->
		<div th:if="${successMessage}" style="color: green">
		    <p th:text="${successMessage}"></p>
		</div>

        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>·∫¢nh</th>
                    <th>T√™n s√°ch</th>
                    <th>T√°c gi·∫£</th>
                    <th>Ng√†y x√°c nh·∫≠n m∆∞·ª£n</th>
                    <th>Ng√†y m∆∞·ª£n</th>
                    <th>Ng√†y tr·∫£</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>H√†nh ƒë·ªông</th>
                    <th>Gia h·∫°n</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="borrowReturn : ${borrowReturns}">
                    <td th:text="${borrowReturn.book.bookId}"></td>

                    <td>
                        <img th:src="@{/images/book_images/{img}(img=${borrowReturn.book.bookImage})}" 
                             alt="·∫¢nh b√¨a" width="80">
                    </td>

                    <td th:text="${borrowReturn.book.bookName}"></td>

                    <td>
                        <span th:each="author, iterStat : ${borrowReturn.book.authors}">
                            <span th:text="${author.authorName}"></span>
                            <span th:if="${!iterStat.last}">, </span>
                        </span>
                    </td>

                    <td class="user-confirm-date" th:text="${borrowReturn.userConfirmDate != null ? #dates.format(borrowReturn.userConfirmDate, 'dd/MM/yyyy') : '------'}"></td>

                    <td th:text="${borrowReturn.startDate != null ? #dates.format(borrowReturn.startDate, 'dd/MM/yyyy') : '------'}"></td>

                    <td th:text="${borrowReturn.endDate != null ? #dates.format(borrowReturn.endDate, 'dd/MM/yyyy') : '------'}"></td>

                    <td>
                        <span th:switch="${borrowReturn.status}">
                            <span th:case="'pending'" class="status-pending">ƒêang ch·ªù</span>
                            <span th:case="'borrowed'" class="status-borrowed">ƒêang m∆∞·ª£n</span>
                            <span th:case="'returned'" class="status-returned">ƒê√£ tr·∫£</span>
                            <span th:case="'outdate'" class="status-outdate">Qu√° h·∫°n</span>
                        </span>
                    </td>

                    <td>
                        <!-- N√∫t x√°c nh·∫≠n m∆∞·ª£n -->
                        <form th:action="@{/admin/borrow-confirm}" method="post"
                              th:if="${borrowReturn.status == 'pending'}"
                              class="confirm-form">
                            <input type="hidden" name="borrowId" th:value="${borrowReturn.id}">
                            <button type="submit" class="btn-confirm"
                            		>
                            	X√°c nh·∫≠n m∆∞·ª£n
                            </button>
                        </form>

                        <!-- N√∫t m·ªü form tr·∫£ s√°ch -->
                        <button th:if="${borrowReturn.status == 'borrowed'}" 
                                class="btn-return" 
                                th:onclick="|openReturnForm(${borrowReturn.id})|">
                            X√°c nh·∫≠n tr·∫£
                        </button>
                        
                        <!-- N·∫øu s√°ch ƒë√£ tr·∫£ -->
						<button th:if="${borrowReturn.status == 'returned'}" class="btn-disabled" disabled>ƒê√£ tr·∫£</button>

						<!-- N·∫øu s√°ch qu√° h·∫°n -->
						<button th:if="${borrowReturn.status == 'outdate'}" class="btn-disabled" disabled>Qu√° h·∫°n</button>
                    </td>
                    
                    <td>
	                     <p th:if="${borrowReturn.renewCount ge 0 and borrowReturn.renewCount lt 2}" 
						    th:text="|ƒê√£ gia h·∫°n: ${borrowReturn.renewCount} l·∫ßn|" 
						    class="renewal-status">
						 </p>
						    
						 <p th:if="${borrowReturn.renewCount ge 2}" class="renewal-status expired">ƒê√£ h·∫øt l∆∞·ª£t gia h·∫°n</p>
	                </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Form pop-up x√°c nh·∫≠n tr·∫£ s√°ch -->
    <div th:each="borrowReturn : ${borrowReturns}" 
         th:id="|returnForm-${borrowReturn.id}|" 
         class="return-form">
        <div class="return-form-content">
            <h3>X√°c nh·∫≠n tr·∫£ s√°ch</h3>
            <form th:action="@{/admin/borrow-return}" method="post">
                <input type="hidden" name="borrowId" th:value="${borrowReturn.id}">

                <label for="condition">T√¨nh tr·∫°ng s√°ch:</label>
                <select name="bookCondition" id="condition">
                    <option value="good">T·ªët</option>
                    <option value="damaged">H∆∞ h·ªèng / M·∫•t s√°ch</option>
                </select>

                <div class="button-group">
                    <button type="submit" class="btn-submit">X√°c nh·∫≠n</button>
                    <button type="button" class="btn-cancel" th:onclick="|closeReturnForm(${borrowReturn.id})|">H·ªßy</button>
                </div>
            </form>
        </div>
    </div>
</body>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".confirm-form").forEach(form => {
            form.addEventListener("submit", function (event) {
                event.preventDefault(); // NgƒÉn form g·ª≠i ngay l·∫≠p t·ª©c

                // L·∫•y gi√° tr·ªã ng√†y x√°c nh·∫≠n m∆∞·ª£n
                let userConfirmDate = this.closest("tr").querySelector(".user-confirm-date").innerText.trim();

                // Ki·ªÉm tra n·∫øu ng√†y x√°c nh·∫≠n m∆∞·ª£n ch∆∞a c√≥ gi√° tr·ªã (ho·∫∑c l√† "------")
                if (!userConfirmDate || userConfirmDate === "------") {
                    Swal.fire({
                        title: "Kh√¥ng th·ªÉ x√°c nh·∫≠n",
                        text: "Kh√¥ng x√°c nh·∫≠n ƒë∆∞·ª£c v√¨ ƒë·ªôc gi·∫£ ch∆∞a x√°c nh·∫≠n!",
                        icon: "warning",
                        confirmButtonColor: "#d33",
                        confirmButtonText: "ƒê√≥ng"
                    });
                } else {
                    Swal.fire({
                        title: "X√°c nh·∫≠n m∆∞·ª£n s√°ch",
                        text: "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√°c nh·∫≠n m∆∞·ª£n s√°ch kh√¥ng?",
                        icon: "question",
                        showCancelButton: true,
                        confirmButtonColor: "#3085d6",
                        cancelButtonColor: "#d33",
                        confirmButtonText: "ƒê·ªìng √Ω",
                        cancelButtonText: "H·ªßy"
                    }).then((result) => {
                        if (result.isConfirmed) {
                            form.submit(); // N·∫øu ng∆∞·ªùi d√πng ƒë·ªìng √Ω, g·ª≠i form
                        }
                    });
                }
            });
        });
    });
</script>


</html>
